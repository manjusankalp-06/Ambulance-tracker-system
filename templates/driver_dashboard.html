<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Dashboard - FastAid</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0d4a73">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FirstAid">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- PWA Manifest -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">

    <!-- App Icons -->
    <link rel="icon" type="image/webp" href="{{ url_for('static', filename='images/icon_amb.webp') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/icon_amb.webp') }}">

    <style>
        :root {
            --fa-primary: #0d6efd;
            --fa-primary-dark: #0b467a;
            --fa-accent: #20c997;
            --fa-bg-card: rgba(15, 23, 42, 0.9);
            --fa-border-subtle: rgba(148, 163, 184, 0.35);
            --fa-text-main: #e5e7eb;
            --fa-text-muted: #9ca3af;
        }

        /* Fullscreen video background */
        #bg-video {
            position: fixed;
            right: 0;
            bottom: 0;
            min-width: 100%;
            min-height: 100%;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -2;
        }

        /* Dark overlay */
        .bg-overlay {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at top, rgba(37, 99, 235, 0.35), transparent 55%),
                        rgba(15, 23, 42, 0.8);
            z-index: -1;
        }

        body {
            min-height: 100vh;
            margin: 0;
            color: var(--fa-text-main);
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        /* Make navbar glassy to match login */
        .navbar {
            background: linear-gradient(to right, rgba(15, 23, 42, 0.95), rgba(30, 64, 175, 0.9)) !important;
            backdrop-filter: blur(14px);
            border-bottom: 1px solid var(--fa-border-subtle);
        }

        .navbar-brand {
            font-weight: 600;
        }

        .request-card {
            border-left: 4px solid var(--fa-primary);
            margin-bottom: 15px;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
            background: var(--fa-bg-card);
            border-radius: 14px;
            border: 1px solid var(--fa-border-subtle);
        }

        .request-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.8);
            border-left-color: var(--fa-accent);
        }

        .status-badge {
            font-size: 0.8rem;
        }

        .patient-info {
            background: rgba(15, 23, 42, 0.85);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px dashed rgba(148, 163, 184, 0.5);
        }

        .info-label {
            font-weight: 600;
            color: #cbd5f5;
        }

        .distance-badge {
            font-size: 0.9rem;
            font-weight: 600;
        }

        h3 {
            color: #f9fafb;
        }

        .alert-info {
            background: rgba(59, 130, 246, 0.15);
            border-color: rgba(59, 130, 246, 0.4);
            color: #dbeafe;
        }

        .btn-outline-light.btn-sm {
            border-radius: 999px;
            border-width: 1px;
        }

        .btn-success {
            background: linear-gradient(135deg, #16a34a, #15803d);
            border: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--fa-primary), var(--fa-primary-dark));
            border: none;
        }

        .btn-outline-primary {
            border-color: var(--fa-primary);
            color: var(--fa-primary);
        }

        .btn-outline-primary:hover {
            background: var(--fa-primary);
            color: #f9fafb;
        }

        .container {
            padding-bottom: 40px;
        }
    </style>
</head>
<body>

<!-- Same background video as login -->
<video id="bg-video" autoplay muted loop playsinline>
    <source src="{{ url_for('static', filename='videos/smoke_bg.mp4') }}" type="video/mp4">
    Your browser does not support HTML5 video.
</video>

<div class="bg-overlay"></div>

<nav class="navbar navbar-dark">
    <div class="container-fluid">
        <span class="navbar-brand">üöë Driver: {{ driver_name }}</span>
        <a href="{{ url_for('driver_logout') }}" class="btn btn-outline-light btn-sm">Logout</a>
    </div>
</nav>

<div class="container mt-4">
    <h3>üìã Available Requests (Sorted by Distance)</h3>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    {% if requests %}
        {% for req in requests %}
        <div class="card request-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h5 class="card-title mb-2">
                            üö® Request #{{ req[0] }}
                            {% if distances and distances[loop.index0] and distances[loop.index0] < 999 %}
                                <span class="badge bg-success ms-2 distance-badge">
                                    üìç {{ "%.1f"|format(distances[loop.index0]) }} km away
                                </span>
                            {% endif %}
                        </h5>
                        
                        <!-- PATIENT DETAILS BOX -->
                        <div class="patient-info">
                            <div class="row">
                                <div class="col-md-4">
                                    <span class="info-label">Patient ID:</span> #{{ req[0] }}
                                </div>
                                <div class="col-md-4">
                                    <span class="info-label">Patient Name:</span> {{ req[2] or 'Not provided' }}
                                </div>
                                <div class="col-md-4">
                                    <span class="info-label">Phone:</span> üìû {{ req[3] or 'N/A' }}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-2">
                            <p class="mb-1"><strong>üìç Pickup:</strong> {{ req[4] or 'See map for location' }}</p>
                            <p class="mb-1"><strong>üè• Hospital:</strong> {{ req[5] or 'Destination on map' }}</p>
                            <p class="mb-0"><strong>üöë Ambulance Type:</strong> {{ req[6] or 'Basic' }}</p>
                        </div>
                    </div>
                    <div class="text-end ms-3">
                        <span class="badge bg-warning text-dark status-badge">{{ req[11] }}</span>
                    </div>
                </div>
                
                <div class="mt-3 d-flex flex-wrap gap-2">
                    {% if req[11] == 'Pending' %}
                        <a href="{{ url_for('driver_accept_request', request_id=req[0]) }}" 
                           class="btn btn-success">‚úì Accept Request</a>
                    {% elif req[11] == 'Started' or req[11] == 'Patient Received' %}
                        <a href="{{ url_for('driver_navigate', request_id=req[0]) }}" 
                           class="btn btn-primary">üó∫Ô∏è Continue Navigation</a>
                    {% endif %}
                    <a href="tel:{{ req[3] }}" class="btn btn-outline-primary btn-sm">üìû Call Patient</a>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="alert alert-info">
            <strong>‚ÑπÔ∏è No pending requests at the moment.</strong><br>
            Please check back later or contact dispatch.
        </div>
    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="{{ url_for('static', filename='js/pwa-register.js') }}"></script>

</body>
</html>
